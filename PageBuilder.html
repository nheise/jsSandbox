<!DOCTYPE html>
<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<meta charset=utf-8 />
<title>Page</title>
<script type="text/javascript">
  
  var page = {
    'href' : 'http://nheise.net/html/pages/425342',
    'head' : {},
    'body' : {
      'href' : 'http://nheise.net/html/elements/body/724352',
      'children' : [
        'http://nheise.net/html/elements/div/264252'
      ]
    }
  };

  var elementDefs = {
    'http://nheise.net/html/elements/textarea' : {
      'href' : 'http://nheise.net/html/elements/textarea',
      'tag' : '<textarea></textarea>',
      'fields' : {
        'attributes' : [ 'class' ],
        'value' : ''
      }
    },
    'http://nheise.net/html/elements/div' : {
      'href' : 'http://nheise.net/html/elements/div',
      'tag' : '<div></div>',
      'fields' : {
        'attributes' : [ 'class' ]
      }
    },
    'http://nheise.net/html/elements/label' : {
      'href' : 'http://nheise.net/html/elements/label',
      'tag' : '<label></label>',
      'fields' : {
        'attributes' : [ 'for', 'class' ],
        'value' : ''
      }
    }
  };
  
  var elements = {
    'http://nheise.net/html/elements/textarea/423542' : {
      'href' : 'http://nheise.net/html/elements/textarea/423542',
      'type' : 'http://nheise.net/html/elements/textarea',
      'dpInstance' : 'http://nheise.net/reports/20123',
      'fieldDataMap' : {
        'attributes' : {},
        'value' : 'comment'
      }
    },
    'http://nheise.net/html/elements/div/264252' : {
      'href' : 'http://nheise.net/html/elements/div/264252',
      'type' : 'http://nheise.net/html/elements/div',
      'fieldDataMap' : {
        'attributes' : {}
      },
      'children' : [
        'http://nheise.net/html/elements/label/352436',
        'http://nheise.net/html/elements/textarea/423542'
      ]
    },
    'http://nheise.net/html/elements/label/352436' : {
      'href' : 'http://nheise.net/html/elements/label/352436',
      'type' : 'http://nheise.net/html/elements/label',
      'fieldDataMap' : {
        'attributes' : {
          'for' : 'http://nheise.net/html/elements/textarea/423542'
        },
        'value' : 'Kommentar:'
      }
    }
  };
      
  var dpInstances = {
    'http://nheise.net/reports/20123' : {
      'href' : 'http://nheise.net/reports/20123',
      'dp' : 'http://nheise.net/report',
      'comment' : 'Da ist etwas falsch gelaufen.'
    }
  };
  
  function DOMBuilder() {
    
    const idSelectorBuilder = new IdSelectorBuilder();
    
    this.buildBody = function( page ) {
      
      for( i in page.body.children ) {
        buildElement( page.body.children[i], page.body.href );
      }
      
    };
    
    function buildElement( href, parentHref ) {
      
      var element = getElement( href );
      
      var dpInstance = getDpInstance( element );
      
      var elementDef = getElementDef( element );
      
      mapElementFieldValuesToDPInstanceFieldValues( element, dpInstance );
      
      var attributes = createElementAttributes( element, dpInstance );
      
      appendIntoDOM( parentHref, elementDef, attributes );
      
      addValueIfElementHasOne( element );
      
      if( element.children ) {
        for( i in element.children ) {
          buildElement( element.children[i], href ) ;
        }
      }
      
    };
    
    function mapElementFieldValuesToDPInstanceFieldValues( element, dpInstance ) {
      // try map value
      if( dpInstance && element.fieldDataMap.value && dpInstance[ element.fieldDataMap.value ] ) {
        element.fieldDataMap.value = dpInstance[ element.fieldDataMap.value ];
      }

      // map attributes
      var attributeMap = element.fieldDataMap.attributes;

      for( key in attributeMap ) {
        // has map counter part in data pattern instance.
        if( dpInstance && dpInstance[attributeMap[key]] ) {
          attributeMap[key] = dpInstance[attributeMap[key]];
        }
      }

    };
    
    function addValueIfElementHasOne( element ) {
      if( element.fieldDataMap.value ) {
        var escapedIdSelector = idSelectorBuilder.build( element.href );
        
        $( escapedIdSelector ).append( element.fieldDataMap.value );
      }
    };
    
    function createElementAttributes( element, dpInstance ) {
      
      var attributes = { 'id' : element.href };
      
      var attributeMap = element.fieldDataMap.attributes;
      
      for( key in attributeMap ) {
        attributes[key] = attributeMap[key];
      }
      
      return attributes;
    }
    
    function appendIntoDOM( parentHref, elementDef, attributes ) {
      var escapedParentIdSelector = idSelectorBuilder.build( parentHref );
      
      $( elementDef.tag, attributes ).appendTo( escapedParentIdSelector );
    };
    
    function getElement( href ) {
      return elements[href];
    };

    function getDpInstance( element ) {
     return dpInstances[ element.dpInstance ];
    };
    
    function getElementDef( element ) {
      return elementDefs[ element.type ];
    };
    
  }
  
  function IdSelectorBuilder() {
    
    this.build = function( id ) {
      return "#" + escapeFullStop( escapeSlash( escapeColon( id ) ) );
    }
    
    function escapeColon( str ) {
      return str.replace( /\:/, "\\\:" );
    };
    
    function escapeSlash( str ) {
      return str.replace( /\//g, "\\/");
    }
    
    function escapeFullStop( str ) {
      return str.replace( /\./, "\\.");
    }
    
  }
  
  $(window).load(function () {
    prepareBody( page );
    
    new DOMBuilder().buildBody( page );
    
  });
  
  function prepareBody( page ) {
    $("body").attr( "id" , page.body.href );
  }
    
</script>
</head>
<body>
</body>
</html>

