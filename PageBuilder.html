<!DOCTYPE html>
<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<meta charset=utf-8 />
<title>Page</title>
<script type="text/javascript">
  
  var page = {
    'href' : 'http://nheise.net/html/pages/425342',
    'head' : {
      'href' : 'http://nheise.net/html/elements/head/2383523',
      'children' : [
        'http://nheise.net/html/elements/style/435234'
      ]
    },
    'body' : {
      'href' : 'http://nheise.net/html/elements/body/724352',
      'children' : [
        'http://nheise.net/html/elements/div/63534',
        'http://nheise.net/html/elements/div/264252'
      ]
    },
    'requestArgs' : { key : 'SUBSYSTEM' },
    'dataPatterns' : { 
      'tenant' : {
        'href' : 'http://nheise.net/tenant',
        'type' : 'entity',
        'uriPatternKeyValueMap' : {
          'key' : 'requestArgs.key'
        }
      }
    }
  };

  var elementDefs = {
    'http://nheise.net/html/elements/style' : {
      'href' : 'http://nheise.net/html/elements/style',
      'tag' : '<style type="text/css"></style>',
      'fields' : {
        'attributes' : [ ],
        'value' : ''
      }
    },
    'http://nheise.net/html/elements/textfield' : {
      'href' : 'http://nheise.net/html/elements/textfield',
      'tag' : '<input type="text"></input>',
      'fields' : {
        'attributes' : [ 'class', 'value' ]
      }
    },
    'http://nheise.net/html/elements/textarea' : {
      'href' : 'http://nheise.net/html/elements/textarea',
      'tag' : '<textarea></textarea>',
      'fields' : {
        'attributes' : [ 'class' ],
        'value' : ''
      }
    },
    'http://nheise.net/html/elements/div' : {
      'href' : 'http://nheise.net/html/elements/div',
      'tag' : '<div></div>',
      'fields' : {
        'attributes' : [ 'class' ]
      }
    },
    'http://nheise.net/html/elements/label' : {
      'href' : 'http://nheise.net/html/elements/label',
      'tag' : '<label></label>',
      'fields' : {
        'attributes' : [ 'for', 'class' ],
        'value' : ''
      }
    }
  };
  
  var elements = {
    'http://nheise.net/html/elements/style/435234' : {
      'href' : 'http://nheise.net/html/elements/style/435234',
      'type' : 'http://nheise.net/html/elements/style',
      'fieldDataMap' : {
        'attributes' : {},
        'value' : 'label.description { vertical-align: top; } textarea, input { font-family: verdana; font-size: .7em; }'
      }
    },
    'http://nheise.net/html/elements/textarea/423542' : {
      'href' : 'http://nheise.net/html/elements/textarea/423542',
      'type' : 'http://nheise.net/html/elements/textarea',
      'fieldDataMap' : {
        'attributes' : {},
        'value' : 'tenant.description'
      }
    },
    'http://nheise.net/html/elements/div/264252' : {
      'href' : 'http://nheise.net/html/elements/div/264252',
      'type' : 'http://nheise.net/html/elements/div',
      'fieldDataMap' : {
        'attributes' : {}
      },
      'children' : [
        'http://nheise.net/html/elements/label/352436',
        'http://nheise.net/html/elements/textarea/423542'
      ]
    },
    'http://nheise.net/html/elements/label/352436' : {
      'href' : 'http://nheise.net/html/elements/label/352436',
      'type' : 'http://nheise.net/html/elements/label',
      'fieldDataMap' : {
        'attributes' : {
          'for' : 'http://nheise.net/html/elements/textarea/423542',
          'class' : 'description'
        },
        'value' : 'Beschreibung:'
      }
    },
    'http://nheise.net/html/elements/div/63534' : {
      'href' : 'http://nheise.net/html/elements/div/63534',
      'type' : 'http://nheise.net/html/elements/div',
      'fieldDataMap' : {
        'attributes' : {}
      },
      'children' : [
        'http://nheise.net/html/elements/label/53426',
        'http://nheise.net/html/elements/textfield/534263'
      ]
    },
    'http://nheise.net/html/elements/textfield/534263' : {
      'href' : 'http://nheise.net/html/elements/textfield/534263',
      'type' : 'http://nheise.net/html/elements/textfield',
      'fieldDataMap' : {
        'attributes' : { 'value' : 'tenant.key' }
      }
    },
    'http://nheise.net/html/elements/label/53426' : {
      'href' : 'http://nheise.net/html/elements/label/53426',
      'type' : 'http://nheise.net/html/elements/label',
      'fieldDataMap' : {
        'attributes' : {
          'for' : 'http://nheise.net/html/elements/textfield/534263'
        },
        'value' : 'Tenant-Key:'
      }
    }
  };
      
  var dpInstances = {
    'http://nheise.net/tenants/SYSTEM' : {
      'href' : 'http://nheise.net/tenants/SYSTEM',
      'dp' : 'http://nheise.net/tenant',
      'fields' : {
        'key' : 'SYSTEM',
        'name' : 'System',
        'description' : 'Der System Mandat.'
      }
    },
    'http://nheise.net/tenants/SUBSYSTEM' : {
      'href' : 'http://nheise.net/tenants/SUBSYSTEM',
      'dp' : 'http://nheise.net/tenant',
      'fields' : {
        'key' : 'SUBSYSTEM',
        'name' : 'Sub-System',
        'description' : 'Der Mandant unter dem System Mandat.',
        'parent' : 'http://nheise.net/tenants/SYSTEM'
      }
    }
  };
  
  var dataPatterns = {
    'http://nheise.net/tenant' : {
      'href' : 'http://nheise.net/tenant',
      'name' : 'tenant',
      'fields' : [ 'key', 'name', 'description' ],
      'dpInstanceURIPatterns' : { 
        'entity' : 'http://nheise.net/tenants/{key}',
        'query' : 'http://nheise.net/tenants'
      }
    }
  };
      
  function DPInstancesLoader( page ) {
    this.page = page;
  }
  DPInstancesLoader.prototype.load = function() {
    this.dataPatterns = this.loadDataPattern();
    
    this.dpInstanceURIs = this.buildDPInstancesURIs();
    
    this.dpInstances = this.loadDPInstances();
    
    return this.dpInstances;
  };
    
  DPInstancesLoader.prototype.buildDPInstancesURIs = function() {
    var dpInstanceURIs = {};
    
    for( dpName in this.dataPatterns ) {
      dpInstanceURIs[ dpName ] = new DPInstanceURIBuilder( this.dataPatterns[ dpName ], this.page.dataPatterns[ dpName ], this.page.requestArgs ).build(); 
    }
    
    return dpInstanceURIs;
  };    
  DPInstancesLoader.prototype.loadDPInstances = function() {
    
    var dpInstances = {};
    
    for( dpName in this.dpInstanceURIs ) {
      
      dpInstances[ dpName ] = this.getDPInstances( this.dpInstanceURIs[ dpName ] );
      
    }
    
    return dpInstances;
  };    
  DPInstancesLoader.prototype.loadDataPattern = function() {
    var dataPatterns = {};
    
    for( dpName in this.page.dataPatterns ) {
      dataPatterns[ dpName ] = this.getDataPattern( this.page.dataPatterns[ dpName ].href ); 
    }
    
    return dataPatterns;
  };
    
  DPInstancesLoader.prototype.getDPInstances = function( href ) {
    return dpInstances[ href ];
  };
  
  DPInstancesLoader.prototype.getDataPattern = function( href ) {
    return dataPatterns[ href ];
  };
 
  function DPInstanceURIBuilder( dataPattern, elementDPOptions, requestArgs ) {
   
    this.build = function() {
      
      var returnStatement = buildReturnStatement();
      
      var params = [ 'requestArgs' ];

      var paramObjects = [ requestArgs ];
        
      return new Function( params, returnStatement ).apply( this, paramObjects );
    };
    
    function buildReturnStatement() {
      
      var returnStatement = dataPattern.dpInstanceURIPatterns[elementDPOptions.type].replace( /{/g, '"+' );
      
      returnStatement = "return \"" + returnStatement.replace( /}/g, '+"' ) + "\"";
      
      for( key in elementDPOptions.uriPatternKeyValueMap ) {
        returnStatement = returnStatement.replace( new RegExp("\\+" + key + "\\+"), "+" + elementDPOptions.uriPatternKeyValueMap[ key ] + "+" );
      }

      return returnStatement;
    };
  }

  function DOMPageBuilder( page ) {
    this.page = page;
    this.dpInstanceLoader = new DPInstancesLoader( this.page );
  }
  DOMPageBuilder.prototype.build = function() {
    this.prepareBodyAndHead();
    
    this.page.dpInstances = this.dpInstanceLoader.load();
    
    this.buildHead();
    this.buildBody();
  };
  DOMPageBuilder.prototype.prepareBodyAndHead = function() {
    $("head").attr( "id" , this.page.head.href );
    $("body").attr( "id" , this.page.body.href );
  }
  DOMPageBuilder.prototype.buildHead = function() {
    for( i in this.page.head.children ) {
      new DOMElementBuilder( this.page.head.children[i], this.page.head.href, this.page ).build();
    }
    
  }; 
  DOMPageBuilder.prototype.buildBody = function() {
    for( i in this.page.body.children ) {
      new DOMElementBuilder( this.page.body.children[i], this.page.body.href, this.page ).build();
    }
  };
  
  function DOMElementBuilder( href, parentHref, page ) {
    this.href = href
    this.parentHref = parentHref;
    this.page = page;
    
    this.idSelectorBuilder = new IdSelectorBuilder();
  };
  
  DOMElementBuilder.prototype.build = function() {
    this.element = this.getElement();

    this.elementDef = this.getElementDef();
    
    this.mapElementFieldValuesToDPInstanceFieldValues();
    
    this.attributes = this.createElementAttributes();
    
    this.appendIntoDOM();
    
    this.addValueIfElementHasOne();
    
    if( this.element.children ) {
      for( i in this.element.children ) {
        new DOMElementBuilder( this.element.children[i], this.href, this.page ).build();
      }
    }
  };
  DOMElementBuilder.prototype.mapElementFieldValuesToDPInstanceFieldValues = function() {
      
    var mapper = new DPInstancesFieldValueMapper();
    mapper.putDPInstances( page.dpInstances );
    
    // try map value
    if( this.element.fieldDataMap.value ) {
      this.element.fieldDataMap.value = mapper.mapValue( this.element.fieldDataMap.value );
    }
    
    // map attributes
    var attributeMap = this.element.fieldDataMap.attributes;
    
    for( key in attributeMap ) {
      attributeMap[key] = mapper.mapValue(attributeMap[key]);
    }
    
  };
  DOMElementBuilder.prototype.addValueIfElementHasOne = function() {
    if( this.element.fieldDataMap.value ) {
      var escapedIdSelector = this.idSelectorBuilder.build( this.element.href );
      
      $( escapedIdSelector ).append( this.element.fieldDataMap.value );
    }
  };
  DOMElementBuilder.prototype.createElementAttributes = function() {
      
    var attributes = { 'id' : this.element.href };
    
    var attributeMap = this.element.fieldDataMap.attributes;
    
    for( key in attributeMap ) {
      attributes[key] = attributeMap[key];
    }
    
    return attributes;
  };
  DOMElementBuilder.prototype.appendIntoDOM = function() {
    var escapedParentIdSelector = this.idSelectorBuilder.build( this.parentHref );
    
    $( this.elementDef.tag ).attr( this.attributes ).appendTo( escapedParentIdSelector );
  };
    
  DOMElementBuilder.prototype.getElement = function() {
    return elements[this.href];
  };
    
  DOMElementBuilder.prototype.getElementDef = function() {
    return elementDefs[ this.element.type ];
  };
  
  function DPInstancesFieldValueMapper() {};
  DPInstancesFieldValueMapper.prototype.mapValue = function( expression ) {
    var evaled;
    try {
      evaled = eval( 'this.' + expression );
    }
    catch(e) {
      
      evaled = expression;
    }
    return evaled ? evaled : expression;
  };
  DPInstancesFieldValueMapper.prototype.putDPInstances = function( dpInstances ) {
    for( var dpInstanceName in dpInstances ) {
      this.putDPInstance( dpInstanceName, dpInstances[ dpInstanceName ] );
    }
  };
  DPInstancesFieldValueMapper.prototype.putDPInstance = function( dpInstanceName, dpInstance ) {
    this[ dpInstanceName ] = dpInstance.fields;
  };
  
  function IdSelectorBuilder() {};
    
  IdSelectorBuilder.prototype.build = function( id ) {
    return "#" + this.escapeFullStop( this.escapeSlash( this.escapeColon( id ) ) );
  };
  
  IdSelectorBuilder.prototype.escapeColon = function( str ) {
    return str.replace( /\:/, "\\\:" );
  };
  
  IdSelectorBuilder.prototype.escapeSlash = function( str ) {
    return str.replace( /\//g, "\\/");
  };
  
  IdSelectorBuilder.prototype.escapeFullStop = function( str ) {
    return str.replace( /\./, "\\.");
  };
  
  $(window).load(function () {
    
    new DOMPageBuilder( page ).build();
    
  });
    
</script>
</head>
<body>
</body>
</html>
