<!DOCTYPE html>
<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<meta charset=utf-8 />
<title>Page</title>
<script type="text/javascript">
  
  var page = {
    'href' : 'http://nheise.net/html/pages/425342',
    'head' : {
      'href' : 'http://nheise.net/html/elements/head/2383523',
      'children' : [
        'http://nheise.net/html/elements/style/435234'
      ]
    },
    'body' : {
      'href' : 'http://nheise.net/html/elements/body/724352',
      'children' : [
        'http://nheise.net/html/elements/h1/73645',
        'http://nheise.net/html/elements/div/264252'
      ]
    },
    'requestArgs' : { key : 'SYSTEM' }
  };

  var elementDefs = {
    'http://nheise.net/html/elements/style' : {
      'href' : 'http://nheise.net/html/elements/style',
      'tag' : '<style type="text/css"></style>',
      'fields' : {
        'attributes' : [ ],
        'value' : ''
      }
    },
    'http://nheise.net/html/elements/textfield' : {
      'href' : 'http://nheise.net/html/elements/textfield',
      'tag' : '<input type="text"></input>',
      'fields' : {
        'attributes' : [ 'class', 'value' ]
      }
    },
    'http://nheise.net/html/elements/textarea' : {
      'href' : 'http://nheise.net/html/elements/textarea',
      'tag' : '<textarea></textarea>',
      'fields' : {
        'attributes' : [ 'class' ],
        'value' : ''
      }
    },
    'http://nheise.net/html/elements/div' : {
      'href' : 'http://nheise.net/html/elements/div',
      'tag' : '<div></div>',
      'fields' : {
        'attributes' : [ 'class' ]
      }
    },
    'http://nheise.net/html/elements/label' : {
      'href' : 'http://nheise.net/html/elements/label',
      'tag' : '<label></label>',
      'fields' : {
        'attributes' : [ 'for', 'class' ],
        'value' : ''
      }
    },
    'http://nheise.net/html/elements/h1' : {
      'href' : 'http://nheise.net/html/elements/h1',
      'tag' : '<h1></h1>',
      'fields' : {
        'attributes' : [ 'class' ],
        'value' : ''
      }
    }
  };
  
  var elements = {
    'http://nheise.net/html/elements/style/435234' : {
      'href' : 'http://nheise.net/html/elements/style/435234',
      'type' : 'http://nheise.net/html/elements/style',
      'fieldDataMap' : {
        'attributes' : {},
        'value' : '* { margin: 0; padding: 0; font-family: verdana; font-size: 1em; outline: 0; } h1 { font-size: 1.3em; margin-bottom: 10px; } .tenantFields label, .tenantFields input, .tenantFields textarea { display: block; } .tenantFields label { margin-top: 5px; }'
      }
    },
    'http://nheise.net/html/elements/h1/73645' : {
      'href' : 'http://nheise.net/html/elements/h1/73645',
      'type' : 'http://nheise.net/html/elements/h1',
      'fieldDataMap' : {
        'attributes' : {},
        'value' : 'Tenant'
      }
    },
    'http://nheise.net/html/elements/div/264252' : {
      'href' : 'http://nheise.net/html/elements/div/264252',
      'type' : 'http://nheise.net/html/elements/div',
      'fieldDataMap' : {
        'attributes' : {
          'class' : 'tenantFields'
        }
      },
      'children' : [
        'http://nheise.net/html/elements/label/53426',
        'http://nheise.net/html/elements/textfield/534263',
        'http://nheise.net/html/elements/label/352436',
        'http://nheise.net/html/elements/textarea/423542'
      ],
      'dataPatterns' : { 
        'tenant' : {
          'href' : 'http://nheise.net/tenant',
          'type' : 'entity',
          'uriPatternKeyValueMap' : {
            'key' : 'requestArgs.key'
          }
        }
      }
    },
    'http://nheise.net/html/elements/label/352436' : {
      'href' : 'http://nheise.net/html/elements/label/352436',
      'type' : 'http://nheise.net/html/elements/label',
      'fieldDataMap' : {
        'attributes' : {
          'for' : 'http://nheise.net/html/elements/textarea/423542',
          'class' : 'description'
        },
        'value' : 'Beschreibung'
      }
    },
    'http://nheise.net/html/elements/textarea/423542' : {
      'href' : 'http://nheise.net/html/elements/textarea/423542',
      'type' : 'http://nheise.net/html/elements/textarea',
      'fieldDataMap' : {
        'attributes' : {},
        'value' : 'tenant.description'
      }
    },
    'http://nheise.net/html/elements/label/53426' : {
      'href' : 'http://nheise.net/html/elements/label/53426',
      'type' : 'http://nheise.net/html/elements/label',
      'fieldDataMap' : {
        'attributes' : {
          'for' : 'http://nheise.net/html/elements/textfield/534263'
        },
        'value' : 'Tenant-Key'
      }
    },
    'http://nheise.net/html/elements/textfield/534263' : {
      'href' : 'http://nheise.net/html/elements/textfield/534263',
      'type' : 'http://nheise.net/html/elements/textfield',
      'fieldDataMap' : {
        'attributes' : { 'value' : 'tenant.key' }
      }
    }
  };
      
  var dpInstances = {
    'http://nheise.net/tenants/SYSTEM' : {
      'href' : 'http://nheise.net/tenants/SYSTEM',
      'dp' : 'http://nheise.net/tenant',
      'fields' : {
        'key' : 'SYSTEM',
        'name' : 'System',
        'description' : 'Der System Mandant.',
        'children' : [
          'http://nheise.net/tenants/SUB1-SYSTEM',
          'http://nheise.net/tenants/SUB2-SYSTEM'
        ]
      }
    },
    'http://nheise.net/tenants/SUB1-SYSTEM' : {
      'href' : 'http://nheise.net/tenants/SUB2-SYSTEM',
      'dp' : 'http://nheise.net/tenant',
      'fields' : {
        'key' : 'SUB1-SYSTEM',
        'name' : 'Sub1-System',
        'description' : 'Der erste Mandant unter dem System Mandant.',
        'parent' : 'http://nheise.net/tenants/SYSTEM'
      }
    },
    'http://nheise.net/tenants/SUB2-SYSTEM' : {
      'href' : 'http://nheise.net/tenants/SUB2-SYSTEM',
      'dp' : 'http://nheise.net/tenant',
      'fields' : {
        'key' : 'SUB2-SYSTEM',
        'name' : 'Sub2-System',
        'description' : 'Der zweite Mandant unter dem System Mandant.',
        'parent' : 'http://nheise.net/tenants/SYSTEM'
      }
    }
  };
  
  var dataPatterns = {
    'http://nheise.net/tenant' : {
      'href' : 'http://nheise.net/tenant',
      'name' : 'tenant',
      'fields' : [ 'key', 'name', 'description' ],
      'dpInstanceURIPatterns' : { 
        'entity' : 'http://nheise.net/tenants/{key}',
        'query' : 'http://nheise.net/tenants'
      }
    }
  };
      
  function DPInstancesLoader( page, element ) {
    this.page = page;
    this.element = element;
    this.dpInstanceURIs = {};
    this.dataPatterns = {};
  }
  DPInstancesLoader.prototype.load = function() {
    this.loadDataPattern();
    
    this.buildDPInstancesURIs();
    
    this.loadDPInstances();
  };
  DPInstancesLoader.prototype.buildDPInstancesURIs = function() {
    
    for( dpName in this.dataPatterns ) {
      this.dpInstanceURIs[ dpName ] = new DPInstanceURIBuilder( this.dataPatterns[ dpName ], this.element.dataPatterns[ dpName ], this.page.requestArgs ).build(); 
    }
  };    
  DPInstancesLoader.prototype.loadDPInstances = function() {
    for( dpName in this.dpInstanceURIs ) {
      this.element.dpInstances[ dpName ] = this.getDPInstances( this.dpInstanceURIs[ dpName ] );
    }
  };
  DPInstancesLoader.prototype.loadDataPattern = function() {
    for( dpName in this.element.dataPatterns ) {
      this.dataPatterns[ dpName ] = this.getDataPattern( this.element.dataPatterns[ dpName ].href ); 
    }
  };  
  DPInstancesLoader.prototype.getDPInstances = function( href ) {
    return dpInstances[ href ];
  };
  DPInstancesLoader.prototype.getDataPattern = function( href ) {
    return dataPatterns[ href ];
  };
 
  function DPInstanceURIBuilder( dataPattern, elementDPOptions, requestArgs ) {
   
    this.build = function() {
      
      var returnStatement = buildReturnStatement();
      
      var params = [ 'requestArgs' ];

      var paramObjects = [ requestArgs ];
        
      return new Function( params, returnStatement ).apply( this, paramObjects );
    };
    
    function buildReturnStatement() {
      
      var returnStatement = dataPattern.dpInstanceURIPatterns[elementDPOptions.type].replace( /{/g, '"+' );
      
      returnStatement = "return \"" + returnStatement.replace( /}/g, '+"' ) + "\"";
      
      for( key in elementDPOptions.uriPatternKeyValueMap ) {
        returnStatement = returnStatement.replace( new RegExp("\\+" + key + "\\+"), "+" + elementDPOptions.uriPatternKeyValueMap[ key ] + "+" );
      }

      return returnStatement;
    };
  }

  function DOMPageBuilder( page ) {
    this.page = page;
  }
  DOMPageBuilder.prototype.build = function() {
    this.prepareBodyAndHead();
    
    new DPInstancesLoader( this.page, this.page ).load();
    
    this.buildHead();
    this.buildBody();
  };
  DOMPageBuilder.prototype.prepareBodyAndHead = function() {
    $("head").attr( "id" , this.page.head.href );
    $("body").attr( "id" , this.page.body.href );
  }
  DOMPageBuilder.prototype.buildHead = function() {
    for( i in this.page.head.children ) {
      new DOMElementBuilder( this.page.head.children[i], this.page.head.href, this.page.dpInstances, this.page ).build();
    }
    
  }; 
  DOMPageBuilder.prototype.buildBody = function() {
    for( i in this.page.body.children ) {
      new DOMElementBuilder( this.page.body.children[i], this.page.body.href, this.page.dpInstances, this.page ).build();
    }
  };
  
  function DOMElementBuilder( href, parentHref, dpInstances, page ) {
    this.href = href
    this.parentHref = parentHref;
    this.page = page;
    
    this.dpInstances = dpInstances || {};
    
    this.idSelectorBuilder = new IdSelectorBuilder();
  };
  
  DOMElementBuilder.prototype.build = function() {
    this.element = this.getElement();

    this.element.dpInstances = this.dpInstances;
    
    new DPInstancesLoader( this.page, this.element ).load();

    this.elementDef = this.getElementDef();
    
    this.mapElementFieldValuesToDPInstanceFieldValues();
    
    this.attributes = this.createElementAttributes();
    
    this.appendIntoDOM();
    
    this.addValueIfElementHasOne();
    
    if( this.element.children ) {
      for( i in this.element.children ) {
        new DOMElementBuilder( this.element.children[i], this.href, this.element.dpInstances, this.page ).build();
      }
    }
  };
  DOMElementBuilder.prototype.mapElementFieldValuesToDPInstanceFieldValues = function() {
      
    var mapper = new DPInstancesFieldValueMapper();
    mapper.putDPInstances( this.element.dpInstances );
    
    // try map value
    if( this.element.fieldDataMap.value ) {
      this.element.fieldDataMap.value = mapper.mapValue( this.element.fieldDataMap.value );
    }
    
    // map attributes
    var attributeMap = this.element.fieldDataMap.attributes;
    
    for( key in attributeMap ) {
      attributeMap[key] = mapper.mapValue(attributeMap[key]);
    }
    
  };
  DOMElementBuilder.prototype.addValueIfElementHasOne = function() {
    if( this.element.fieldDataMap.value ) {
      var escapedIdSelector = this.idSelectorBuilder.build( this.element.href );
      
      $( escapedIdSelector ).append( this.element.fieldDataMap.value );
    }
  };
  DOMElementBuilder.prototype.createElementAttributes = function() {
      
    var attributes = { 'id' : this.element.href };
    
    var attributeMap = this.element.fieldDataMap.attributes;
    
    for( key in attributeMap ) {
      attributes[key] = attributeMap[key];
    }
    
    return attributes;
  };
  DOMElementBuilder.prototype.appendIntoDOM = function() {
    var escapedParentIdSelector = this.idSelectorBuilder.build( this.parentHref );
    
    $( this.elementDef.tag ).attr( this.attributes ).appendTo( escapedParentIdSelector );
  };
    
  DOMElementBuilder.prototype.getElement = function() {
    return elements[this.href];
  };
    
  DOMElementBuilder.prototype.getElementDef = function() {
    return elementDefs[ this.element.type ];
  };
  
  function DPInstancesFieldValueMapper() {};
  DPInstancesFieldValueMapper.prototype.mapValue = function( expression ) {
    var evaled;
    try {
      evaled = eval( 'this.' + expression );
    }
    catch(e) {
      
      evaled = expression;
    }
    return evaled ? evaled : expression;
  };
  DPInstancesFieldValueMapper.prototype.putDPInstances = function( dpInstances ) {
    for( var dpInstanceName in dpInstances ) {
      this.putDPInstance( dpInstanceName, dpInstances[ dpInstanceName ] );
    }
  };
  DPInstancesFieldValueMapper.prototype.putDPInstance = function( dpInstanceName, dpInstance ) {
    this[ dpInstanceName ] = dpInstance.fields;
  };
  
  function IdSelectorBuilder() {};
    
  IdSelectorBuilder.prototype.build = function( id ) {
    return "#" + this.escapeFullStop( this.escapeSlash( this.escapeColon( id ) ) );
  };
  
  IdSelectorBuilder.prototype.escapeColon = function( str ) {
    return str.replace( /\:/, "\\\:" );
  };
  
  IdSelectorBuilder.prototype.escapeSlash = function( str ) {
    return str.replace( /\//g, "\\/");
  };
  
  IdSelectorBuilder.prototype.escapeFullStop = function( str ) {
    return str.replace( /\./, "\\.");
  };
  
  $(window).load(function () {
    
    new DOMPageBuilder( page ).build();
    
  });
    
</script>
</head>
<body>
</body>
</html>

