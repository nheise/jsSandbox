<!DOCTYPE html>
<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<meta charset=utf-8 />
<title>Page</title>
<script type="text/javascript">
  
  var page = {
    'href' : 'http://nheise.net/html/pages/425342',
    'head' : {
      'href' : 'http://nheise.net/html/elements/head/2383523',
      'children' : [
        'http://nheise.net/html/elements/style/435234'
      ]
    },
    'body' : {
      'href' : 'http://nheise.net/html/elements/body/724352',
      'children' : [
        'http://nheise.net/html/elements/div/63534',
        'http://nheise.net/html/elements/div/264252'
      ]
    },
    'requestArgs' : { key : 'SUBSYSTEM' },
    'dataPatterns' : { 
      'tenant' : {
        'href' : 'http://nheise.net/tenant',
        'type' : 'entity',
        'uriPatternKeyValueMap' : {
          'key' : 'requestArgs.key'
        }
      }
    }
  };

  var elementDefs = {
    'http://nheise.net/html/elements/style' : {
      'href' : 'http://nheise.net/html/elements/style',
      'tag' : '<style type="text/css"></style>',
      'fields' : {
        'attributes' : [ ],
        'value' : ''
      }
    },
    'http://nheise.net/html/elements/textfield' : {
      'href' : 'http://nheise.net/html/elements/textfield',
      'tag' : '<input type="text"></input>',
      'fields' : {
        'attributes' : [ 'class', 'value' ]
      }
    },
    'http://nheise.net/html/elements/textarea' : {
      'href' : 'http://nheise.net/html/elements/textarea',
      'tag' : '<textarea></textarea>',
      'fields' : {
        'attributes' : [ 'class' ],
        'value' : ''
      }
    },
    'http://nheise.net/html/elements/div' : {
      'href' : 'http://nheise.net/html/elements/div',
      'tag' : '<div></div>',
      'fields' : {
        'attributes' : [ 'class' ]
      }
    },
    'http://nheise.net/html/elements/label' : {
      'href' : 'http://nheise.net/html/elements/label',
      'tag' : '<label></label>',
      'fields' : {
        'attributes' : [ 'for', 'class' ],
        'value' : ''
      }
    }
  };
  
  var elements = {
    'http://nheise.net/html/elements/style/435234' : {
      'href' : 'http://nheise.net/html/elements/style/435234',
      'type' : 'http://nheise.net/html/elements/style',
      'fieldDataMap' : {
        'attributes' : {},
        'value' : 'label.description { vertical-align: top; } textarea, input { font-family: verdana; font-size: .7em; }'
      }
    },
    'http://nheise.net/html/elements/textarea/423542' : {
      'href' : 'http://nheise.net/html/elements/textarea/423542',
      'type' : 'http://nheise.net/html/elements/textarea',
      'fieldDataMap' : {
        'attributes' : {},
        'value' : 'tenant.description'
      }
    },
    'http://nheise.net/html/elements/div/264252' : {
      'href' : 'http://nheise.net/html/elements/div/264252',
      'type' : 'http://nheise.net/html/elements/div',
      'fieldDataMap' : {
        'attributes' : {}
      },
      'children' : [
        'http://nheise.net/html/elements/label/352436',
        'http://nheise.net/html/elements/textarea/423542'
      ]
    },
    'http://nheise.net/html/elements/label/352436' : {
      'href' : 'http://nheise.net/html/elements/label/352436',
      'type' : 'http://nheise.net/html/elements/label',
      'fieldDataMap' : {
        'attributes' : {
          'for' : 'http://nheise.net/html/elements/textarea/423542',
          'class' : 'description'
        },
        'value' : 'Beschreibung:'
      }
    },
    'http://nheise.net/html/elements/div/63534' : {
      'href' : 'http://nheise.net/html/elements/div/63534',
      'type' : 'http://nheise.net/html/elements/div',
      'fieldDataMap' : {
        'attributes' : {}
      },
      'children' : [
        'http://nheise.net/html/elements/label/53426',
        'http://nheise.net/html/elements/textfield/534263'
      ]
    },
    'http://nheise.net/html/elements/textfield/534263' : {
      'href' : 'http://nheise.net/html/elements/textfield/534263',
      'type' : 'http://nheise.net/html/elements/textfield',
      'fieldDataMap' : {
        'attributes' : { 'value' : 'tenant.key' }
      }
    },
    'http://nheise.net/html/elements/label/53426' : {
      'href' : 'http://nheise.net/html/elements/label/53426',
      'type' : 'http://nheise.net/html/elements/label',
      'fieldDataMap' : {
        'attributes' : {
          'for' : 'http://nheise.net/html/elements/textfield/534263'
        },
        'value' : 'Tenant-Key:'
      }
    }
  };
      
  var dpInstances = {
    'http://nheise.net/tenants/SYSTEM' : {
      'href' : 'http://nheise.net/tenants/SYSTEM',
      'dp' : 'http://nheise.net/tenant',
      'fields' : {
        'key' : 'SYSTEM',
        'name' : 'System',
        'description' : 'Der System Mandat.'
      }
    },
    'http://nheise.net/tenants/SUBSYSTEM' : {
      'href' : 'http://nheise.net/tenants/SUBSYSTEM',
      'dp' : 'http://nheise.net/tenant',
      'fields' : {
        'key' : 'SUBSYSTEM',
        'name' : 'Sub-System',
        'description' : 'Der Mandant unter dem System Mandat.',
        'parent' : 'http://nheise.net/tenants/SYSTEM'
      }
    }
  };
  
  var dataPatterns = {
    'http://nheise.net/tenant' : {
      'href' : 'http://nheise.net/tenant',
      'name' : 'tenant',
      'fields' : [ 'key', 'name', 'description' ],
      'dpInstanceURIPatterns' : { 
        'entity' : 'http://nheise.net/tenants/{key}',
        'query' : 'http://nheise.net/tenants'
      }
    }
  };
      
  function DPInstancesLoader( page ) {
    
    this.load = function() {
      var dataPatterns = loadDataPattern();
      
      var dpInstanceURIs = buildDPInstancesURIs( dataPatterns );
      
      var dpInstances = loadDPInstances( dpInstanceURIs );
      
      return dpInstances;
    };
    
    function buildDPInstancesURIs( dataPatterns ) {
      var dpInstanceURIs = {};
      
      for( dpName in dataPatterns ) {
        dpInstanceURIs[ dpName ] = new DPInstanceURIBuilder( dataPatterns[ dpName ], page.dataPatterns[ dpName ], page.requestArgs ).build(); 
      }
      
      return dpInstanceURIs;
    }
    
    function loadDPInstances( dpInstanceURIs ) {
      
      var dpInstances = {};
      
      for( dpName in dpInstanceURIs ) {
        
        dpInstances[ dpName ] = getDPInstances( dpInstanceURIs[ dpName ] );
        
      }
      
      return dpInstances;
    };
    
    function loadDataPattern() {
      var dataPatterns = {};
      
      for( dpName in page.dataPatterns ) {
        dataPatterns[ dpName ] = getDataPattern( page.dataPatterns[ dpName ].href ); 
      }
      
      return dataPatterns;
    };
  };
    
  function getDPInstances( href ) {
    return dpInstances[ href ];
  };
  
  function getDataPattern( href ) {
    return dataPatterns[ href ];
  };
 
  function DPInstanceURIBuilder( dataPattern, elementDPOptions, requestArgs ) {
   
    this.build = function() {
      
      var returnStatement = buildReturnStatement();
      
      var params = [ 'requestArgs' ];

      var paramObjects = [ requestArgs ];
        
      return new Function( params, returnStatement ).apply( this, paramObjects );
    };
    
    function buildReturnStatement() {
      
      var returnStatement = dataPattern.dpInstanceURIPatterns[elementDPOptions.type].replace( /{/g, '"+' );
      
      returnStatement = "return \"" + returnStatement.replace( /}/g, '+"' ) + "\"";
      
      for( key in elementDPOptions.uriPatternKeyValueMap ) {
        returnStatement = returnStatement.replace( new RegExp("\\+" + key + "\\+"), "+" + elementDPOptions.uriPatternKeyValueMap[ key ] + "+" );
      }

      return returnStatement;
    };
  }

  function DOMBuilder( page ) {
    
    const idSelectorBuilder = new IdSelectorBuilder();
    const dpInstanceLoader = new DPInstancesLoader( page );
    
    this.build = function() {
      prepareBodyAndHead();
      
      page.dpInstances = dpInstanceLoader.load();
      
      buildHead();
      buildBody();
    };
  
    function prepareBodyAndHead() {
      $("head").attr( "id" , page.head.href );
      $("body").attr( "id" , page.body.href );
    }
    
    function buildHead() {
      
      for( i in page.head.children ) {
        buildElement( page.head.children[i], page.head.href );
      }
      
    };
    
    function buildBody() {
      
      for( i in page.body.children ) {
        buildElement( page.body.children[i], page.body.href );
      }
      
    };
    
    function buildElement( href, parentHref ) {
      
      var element = getElement( href );
      
      var elementDef = getElementDef( element );
      
      mapElementFieldValuesToDPInstanceFieldValues( element );

      var attributes = createElementAttributes( element );
      
      appendIntoDOM( parentHref, elementDef, attributes );
      
      addValueIfElementHasOne( element );

      if( element.children ) {
        for( i in element.children ) {
          buildElement( element.children[i], href ) ;
        }
      }
    };
    
    function mapElementFieldValuesToDPInstanceFieldValues( element ) {
      
      var mapper = new DPInstancesFieldValueMapper();
      mapper.putDPInstances( page.dpInstances );
      
      // try map value
      if( element.fieldDataMap.value ) {
        element.fieldDataMap.value = mapper.mapValue( element.fieldDataMap.value );
      }
      
      // map attributes
      var attributeMap = element.fieldDataMap.attributes;

      for( key in attributeMap ) {
        attributeMap[key] = mapper.mapValue(attributeMap[key]);
      }
      
    };
    
    function addValueIfElementHasOne( element ) {
      if( element.fieldDataMap.value ) {
        var escapedIdSelector = idSelectorBuilder.build( element.href );
        
        $( escapedIdSelector ).append( element.fieldDataMap.value );
      }
    };
    
    function createElementAttributes( element, dpInstance ) {
      
      var attributes = { 'id' : element.href };
      
      var attributeMap = element.fieldDataMap.attributes;
      
      for( key in attributeMap ) {
        attributes[key] = attributeMap[key];
      }
      
      return attributes;
    }
    
    function appendIntoDOM( parentHref, elementDef, attributes ) {
      var escapedParentIdSelector = idSelectorBuilder.build( parentHref );
      
      $( elementDef.tag ).attr( attributes ).appendTo( escapedParentIdSelector );
    };
    
    function getElement( href ) {
      return elements[href];
    };
    
    function getElementDef( element ) {
      return elementDefs[ element.type ];
    };
    
  }
  
  function DPInstancesFieldValueMapper() {};
  DPInstancesFieldValueMapper.prototype.mapValue = function( expression ) {
    var evaled;
    try {
      evaled = eval( 'this.' + expression );
    }
    catch(e) {
      
      evaled = expression;
    }
    return evaled ? evaled : expression;
  };
  DPInstancesFieldValueMapper.prototype.putDPInstances = function( dpInstances ) {
    for( var dpInstanceName in dpInstances ) {
      this.putDPInstance( dpInstanceName, dpInstances[ dpInstanceName ] );
    }
  };
  DPInstancesFieldValueMapper.prototype.putDPInstance = function( dpInstanceName, dpInstance ) {
    this[ dpInstanceName ] = dpInstance.fields;
  };
  
  function IdSelectorBuilder() {
    
    this.build = function( id ) {
      return "#" + escapeFullStop( escapeSlash( escapeColon( id ) ) );
    };
    
    function escapeColon( str ) {
      return str.replace( /\:/, "\\\:" );
    };
    
    function escapeSlash( str ) {
      return str.replace( /\//g, "\\/");
    };
    
    function escapeFullStop( str ) {
      return str.replace( /\./, "\\.");
    };
    
  }
  
  $(window).load(function () {
    
    new DOMBuilder( page ).build();
    
  });
    
</script>
</head>
<body>
</body>
</html>
